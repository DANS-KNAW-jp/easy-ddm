<H1>
	Checklist / cheat sheet - nieuw OAI-PMH formaat <br /> toevoegen aan
	EASY

</h1>
<p>Dit is een checklist alias spiekbriefje, voor achtergronden en
	details zie</p>
<p>
	<a
		href="https://www.dropbox.com/home/AHV/AHV%20Applicaties/PROAI?select=PROAI.docx">
		https://www.dropbox.com/home/AHV/AHV
		Applicaties/PROAI?select=PROAI.docx </a>
</p>
<p>Gele markering accentueren verschillen</p>
<ul>
	<li>Fedora object
		ID:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
		f/p</li>
	<li>
		Systeem:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
		evm, localhost, eof12, teasy, easy alias eof13</li>
	<li>
		Poortnummer&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
		8080, 5432</li>
	<li>Gebruikte
		dataset:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1
	</li>
	<li>Toe te voegen formaat:&#160;&#160; oai_datacite</li>
</ul>
<p>Behalve voor de object-ID's moeten andere waardes ingevuld worden
	voor andere situaties/formaten.</p>
<h1>Requirements</h1>
<h2>Specificaties voor de configuratie van een nieuw formaat</h2>
<ul>
	<li>Een XSL file om EMD te transformeren naar het gewenste
		formaat.</li>
	<li>Meta dataPrefix (zoals: oai_dc, carare, nl_diddl,
		oai_datacite).</li>
	<li>URL van de XSD van het gewenste formaat.</li>
	<li>URI van de namespace van het gewenste formaat.</li>
	<li>Beperken tot een set? Zo ja, zie PROAI.docx en neem dan niet
		oai_dc of nl_didl als voorbeeld maar carare. Voeg benodigde gegevens
		toe aan het configuratie hoofdstuk van deze cheat sheet.</li>
</ul>
<p>
	URL en URI zijn in de stylesheet te vinden bij: <strong>&lt;</strong><strong>xsl:attribute
	</strong><strong>name</strong>=<em>"xsi:schemaLocation"</em>
</p>
<h2>Tools</h2>
<ul>
	<li>Fedora kun je configureren met de web administrator <br />
		URL <a href="http://evm:8080/fedora/admin/">http://evm:8080/fedora/admin/</a>
	</li>
	<li>OAI herstarten kan met tomcat, URL <a
		href="http://localhost:8080/manager/html/">http://localhost:8080/manager/html/</a>
		<br /> of met het script (werkt dat nog wel?):
		/opt/proai-1.2.2.c/proai
	</li>
	<li>Eventueel de OAI cache voor een enkel formaat legen: <br />
		&#160;PgAdmin (gui) of PSQL (command-line voorbeeld: psql -p 5432 -U
		proai proai) zet 0 (zero) in de kolom "lastpolldate" in de tabel
		"rcformat" voor het formaat of verwijder de rij.
	</li>
</ul>
<h2>Gebruikersnamen en wachtwoorden</h2>
<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td valign="top">
				<p>
					<strong>system</strong>
				</p>
			</td>
			<td valign="top">
				<p>
					<strong>file</strong>
				</p>
			</td>
			<td valign="top">
				<p>
					<strong>element</strong>
				</p>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<p>Fedora administrator</p>
			</td>
			<td valign="top">
				<p>application.properties</p>
			</td>
			<td valign="top">
				<p>fedora.admin.*</p>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<p>tomcat</p>
			</td>
			<td valign="top">
				<p>/etc/tomcat6/tomcat-users.xml</p>
			</td>
			<td valign="top">&nbsp;</td>
		</tr>
		<tr>
			<td valign="top">
				<p>OAI database</p>
			</td>
			<td valign="top">
				<p>
					/var/lib/tomcat6/webapps/oai/WEB-INF/classes/proai.properties</p>
			</td>
			<td valign="top">
				<p>proai.db.*</p>
			</td>
		</tr>
	</tbody>
</table>
<h2>Tunnels</h2>
<p>
	Om binnen de firewall van DANS te komen: rond gemailde instructies
	volgen over de VPN client<br />Dan nog heb je in ieder geval een
	tunnel nodig voor bijvoorbeeld voor Tomcat op eof12
</p>
<p>
	vanaf een terminal met het commando (je eigen userid invullen): <br />
	ssh -L 8080:localhost:8080 <a href="mailto:USERID@eof12.dans.knaw.nl">USERID@eof12.dans.knaw.nl</a>
	<br /> gebruik dan in de browser "localhost" in plaats van
	"eof12.dans.knaw.nl"
</p>
<h1>Configuratie</h1>
<p>
	<strong>Copy/paste</strong> bij voorkeur van bestaande, werkende
	formaten. Dat voorkomt problemen met subtiele verschillen in tekens uit
	word-documenten zoals streepjes, quotes en afgebroken regels.
</p>
<h2>Fedora</h2>
<p>
	<strong>Geen copy/paste</strong> (optie XML from text) gebruiken om de
	stylesheet toe te voegen. Anders stript de fedora parser comments en
	verhaspelt spacing en linebreaks, waardoor de stylesheet minder goed te
	lezen is. Daar de admin interface van Fedora is experimenteel kan het
	echter zijn dat uploaden niet lukt.
</p>
<p>
	<strong>Naamgevingsconventies</strong> : gebruik telkens de
	gespecificeerde metadata-prefix, bijvoorbeeld: getOAI_DataCiteRequest,
	EMD_oai_datacite.xsl
</p>
<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td valign="top">
				<p>
					<strong>Object id</strong>
				</p>
			</td>
			<td valign="top">
				<p>
					<strong>datastream</strong>
				</p>
			</td>
			<td valign="top">
				<p>
					<strong>XML elementen / formuliervelden</strong>
				</p>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<p>easy-sdef:oai-item1</p>
			</td>
			<td valign="top">
				<p>METHODMAP</p>
			</td>
			<td valign="top">
				<p>&lt;fmm:Method&gt;</p>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<p>easy-sdep:oai-item1</p>
			</td>
			<td valign="top">
				<p>METHODMAP</p>
			</td>
			<td valign="top">
				<p>&lt;fmm:Method&gt;</p>
			</td>
		</tr>
		<tr>
			<td valign="top"></td>
			<td valign="top">
				<p>DSINPUTSPEC</p>
			</td>
			<td valign="top">
				<p>&lt;fbs:DSInput&gt;</p>
			</td>
		</tr>
		<tr>
			<td valign="top"></td>
			<td valign="top">
				<p>WSDL</p>
			</td>
			<td valign="top">
				<p>
					&lt;wsdl:message&gt;<br />
					&lt;wsdl:portType&gt;&lt;wsdl:operation&gt;<br />
					&lt;/wsdl:binding&gt;&lt;wsdl:operation&gt;
				</p>
			</td>
		</tr>
		<tr>
			<td valign="top"></td>
			<td valign="top" width="92">
				<p>
					<em>nieuw</em>
				</p>
			</td>
			<td valign="top">
				<p>
					ID:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
					EMD_oai_datacite.xsl<br />Label:&#160;&#160;&#160;&#160;&#160;&#160;
					Stylesheet for transformation from EMD to oai_datacite<br />Content:&#160;
					XSL transformatie
				</p>
			</td>
		</tr>
	</tbody>
</table>
<p>Objecten die moeten bestaan (geen inhoud nodig)</p>
<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td valign="top">
				<p>
					<strong>Object ID</strong>
				</p>
			</td>
			<td valign="top">
				<p>
					<strong>Label</strong>
				</p>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<p>easy-model:EDM1DATASET</p>
			</td>
			<td valign="top">
				<p>Content Model for EDM DATASET</p>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<p>dans-model:recursive-item-v1</p>
			</td>
			<td valign="top">
				<p>Content Model for Recursive Item</p>
			</td>
		</tr>
	</tbody>
</table>
<h2>PrOAI</h2>
<table border="1" cellpadding="0" cellspacing="0">
	<tbody>
		<tr>
			<td valign="top">
				<p>
					<strong>file</strong>
				</p>
			</td>
			<td valign="top">
				<p>
					<strong>element</strong>
				</p>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<p>proai.properties</p>
			</td>
			<td valign="top">
				<p>driver.fedora.md.*</p>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<p>/var/lib/tomcat6/webapps/oai/static/oai-pmh.xsl</p>
			</td>
			<td valign="top">
				<p>&lt;format:prefixes&gt;</p>
			</td>
		</tr>
	</tbody>
</table>
<h1>Permanente configuratie</h1>
<p>vet gedrukt onderdelen aanpassen aan de situatie</p>
<p>Te wijzigen source files:</p>
<ul>
	<li>easy-backend/src/main/assembly/dist/easy-fedora-commons-repository/
		<ul>
			<li><code>
					basic-digital-objects/easy-sde<b>*</b>:oai-item1.xml
				</code></li>
			<li><code>oai-pmh/add-oai-pmh-support.sh</code></li>
			<li><code>
					oai-pmh/EMD_<b>oai_datacite</b>.xsl
				</code> (nieuw)</li>
		</ul>
	</li>
	<li>easy-proai/src/main/
		<ul>
			<li><code>webapp/oai-pmh.xsl</code></li>
			<li><code>assembly/dist/cfg/proai.properties</code></li>
		</ul>
	</li>
</ul>
<p>
	Benodigde acties op de <b>EVM</b>
</p>
<ul>
	<li>easy-backend
		<ul>
			<li>Resultaat van <code>mvn clean install</code> overzetten en
				uitpakken: <br /> <code>
					sudo tar -xzvf easy-backend-<b>2.9</b>.tar.gz -C /opt
				</code></li>
			<li>Verwijder handmatig met de fedora web-client de objecten:<br />
				<code>
					easy-sde<b>f</b>:oai-item1
				</code> en <br /> <code>
					easy-sde<b>p</b>:oai-item1
				</code></li>
			<li>De overeenkomstige XML's weer toevoegen (let op quotes, help
				info van command klopt niet):<br> <code>
					cd /opt/easy-backend-<b>2.9</b>/easy-fedora-commons-repository/basic-digital-objects/
					<br />fedora-ingest.sh file "easy-sde<b>p</b>:oai-item1.xml"
					"info:fedora/fedora-system:FOXML-1.1" "localhost:8080" fedoraAdmin
					<b>&lt;password&gt;</b> http <br />fedora-ingest.sh file "easy-sde<b>f</b>:oai-item1.xml"
					"info:fedora/fedora-system:FOXML-1.1" "localhost:8080" fedoraAdmin
					<b>&lt;password&gt;</b> http
				</code>
			</li>
			<li>De xsl files als datastreams aan de vernieuwde objecten
				toevoegen: <br /> <code>
					cd /opt/easy-backend-<b>2.9</b>/easy-fedora-commons-repository/oai-pmh/<br />
					sudo ./add-oai-pmh-support.sh &lt;password:fedoraAdmin&gt;
				</code>

			</li>
			<li>Tomcat herstarten:<br> <code>sudo service
					tomcat6 force-reload; tail -f -n200 /var/log/tomcat6/catalina.out</code></li>
		</ul>
	</li>
	<li>easy-proai (niet te verwarren met proai)
		<ul>
			<li>Volg eenmalig het volledige hoofdtuk "EASY Customized PrOAI
				Module (Optional)" uit de <a href="EASY Installation Guide.docx">EASY
					Installation Guide</a>.
			</li>
			<li>Voor een update resultaat van <code>mvn clean install</code>
				overzetten, uitpakken en opnieuw linken: <pre>
sudo tar -xzvf easy-proai-<b>1.1</b>.tar.gz -C /opt
sudo ln -s /opt/easy-proai-<b>1.1</b>/ /opt/easy-proai
</pre> Vervolgens passwoorden aanpassen en deployen: <pre>
vi /opt/easy-proai/cfg/proai.properties
sudo cp /opt/easy-proai/bin/oai.xml /etc/tomcat6/Catalina/localhost; tail -f /var/log/tomcat6/catalina.out
sudo service tomcat6 force-reload; tail -f -n200 /var/log/tomcat6/catalina.out
</pre>
			</li>
			<li>Na opnieuw deployen moet eventueel de cache leeggemaakt
				worden. Verwijder of rename de folder <code>/data/proai/cach</code>
				en zet de <code>lastpolldate</code> in de tabel <code>rcformat</code>
				voor het betreffende format op 0. Bijvoorbeeld met <pre>
$ sudo -u postgres psql -U postgres
# \c proai_db
# select * from rcformat;
# update rcformat set lastpolldate=0 where mdprefix='oai_datacite';
# \q
$				</pre>
			</li>
		</ul>
	</li>
</ul>
<h1>Test</h1>
<p>
	Geen herstart nodig om te testen met bijvoorbeeld <a
		href="http://evm:8080/fedora/objects/easy-dataset:1/methods">http://evm:8080/fedora/objects/easy-dataset:1/methods</a>
</p>
<p>
	Wel een herstart nodig met eventueel harde refresh in browser voor <a
		href="http://evm:8080/oai/?verb=GetRecord&metadataPrefix=oai_datacite&identifier=oai:easy.dans.knaw.nl:easy-dataset:1">http://evm:8080/oai/?verb=GetRecord&metadataPrefix=oai_datacite&identifier=oai:easy.dans.knaw.nl:easy-dataset:1</a><br />
	<img src="add-OAI-format-CheatSheet-test.png" border="0" height="143"
		width="452">
</p>
<h1>Fedora trouble shooting</h1>
<p>Per request worden de onverwachte gevolgen of een deel van de
	stack-trace in een kader getoond, gevolgd door een toegepaste
	oplossing.</p>
<h2>Opslaan data stream</h2>
<div style="border: solid">
	<p>Xml syntax error in stap 5</p>
</div>
<p>copy-paste van de afgebroken regels (\) uit de handleiding werken
	niet</p>
<h2>
	<a href="https://evm:8080/fedora/objects/easy-dataset:1/methods">https://evm:8080/fedora/objects/easy-dataset:1/methods</a>
</h2>
<div style="border: solid">
	<p>Beveiligde verbinding mislukt</p>
	<p>Fout tijdens het verbinden met localhost:8080. SSL ontving een
		record die de maximaal toegestane lengte overschreed. (Foutcode:
		ssl_error_rx_record_too_long)</p>
</div>
<p>
	Geen http<strong>s</strong> gebruiken.
</p>
<h2>
	<a href="http://evm:8080/fedora/objects/easy-dataset:1/methods">http://evm:8080/fedora/objects/easy-dataset:1/methods</a>
</h2>
<div style="border: solid">
	<p>Nieuwe formaat wordt niet getoond</p>
</div>
<p>sdef ontbreekt</p>
<h2>
	<a
		href="http://evm:8080/fedora/objects/easy-dataset:1/methods/easy-sdef:oai-item1/getOAI_DataCite">
		http://evm:8080/fedora/objects/easy-dataset:1/methods/easy-sdef:oai-item1/getOAI_DataCite</a>
</h2>
<div style="border: solid">
	<p>
		Caused by: &#8230;GeneralException: ServiceMapper returned error. The
		underlying error was a java.lang.NullPointerException.&#160; The
		message was "null" &#8230;ServiceMapper.parse(ServiceMapper.java:193)
		<br /> &#8230;ServiceMapper.getService(ServiceMapper.java:153) <br />
		&#8230;ServiceMapper.getMethodDefBindings(ServiceMapper.java:124)
	</p>
</div>
<p>Foutje in WSDL, onjuiste message/operation name:</p>
<p>
	&lt;wsdl:message name=<em>"getOAI_dataciteRequest"</em>&gt;
</p>
<p>
	&lt;wsdl:operation name=<em>"getOAI_datacite"</em>&gt;
</p>
<div style="border: solid">
	<p>
		&#8230; <br /> Caused by: &#8230; Error getting
		http://evm:8080/saxon/SaxonServlet?source=<em>http://evm:8080/fedora/get/easy-dataset:1/EMD/2013-11-22T12:58:03.891Z</em>&amp;style=
		<em>http://evm:8080/fedora/get/easy-sdep:oai-item1/EMD_oai_datacite.xsl/2012-08-28T11:10:01.455Z</em>&amp;clear-stylesheet-cache=false
		<br /> &#8230; Caused by: &#8230;ConnectTimeoutException: The host
		did not accept the connection within timeout of 20000 ms &#8230;
	</p>
</div>
<p>Op alle formaten:</p>
<p>Op de EVM stond een verkeerd IP adres in de file /etc/hosts, zie
	ook:</p>
<ul>
	<li>
		smb://10.169.32.22/develop/centos-6.2-x86_64-server/evm-1.0.zip/manual.pdf</li>
	<li>
		smb://10.169.32.22/develop/centos-6.2-x86_64-server/evm-1.0-manual-addendum-VM-warefusion-4.doc
	</li>
</ul>
<p>Alleen bij het nieuwe formaat</p>
<p>XSL datastream bevatte iets anders dan een style sheet.</p>
<div style="border: solid">
	<p>javax.ws.rs.WebApplicationException:
		org.fcrepo.server.errors.MethodNotFoundException: Method
		getOpenAIREplus was not found in easy-sdep:oai-item1's operation&#160;
		binding.</p>
</div>
<p>&lt;wsdl:operation&gt; per ongeluk na &lt;/wsdl:binding&gt; gezet
</p>
<h2>
	<a
		href="http://evm:8080/oai/?verb=GetRecord&metadataPrefix=oai_datacite&identifier=oai:easy.dans.knaw.nl:easy-dataset:1">
		http://evm:8080/oai/?verb=GetRecord&metadataPrefix=oai_datacite&identifier=oai:easy.dans.knaw.nl:easy-dataset:1</a>
</h2>
<div style="border: solid">
	<pre>
	cannotDisseminateFormat
	the indicated item does not support that metadata format
	</pre>
</div>
<p>typo in proai.properties >
	driver.fedora.md.format.oai_datacite.dissType</p>
